name: Convert Markdown to PDF
on:
  push:
    paths:
      - '**.md'  # Trigger only when .md files change
      
jobs:
  convert:
    runs-on: ubuntu-latest
    # Uses GitHub's native runner with Git preinstalled
    container:
      image: pandoc/latex:latest  # Official Pandoc+LaTeX image with ubuntu! (default is with alpine)
      
    steps:
      - name: Install Git
        run: |
          if [ -f /etc/alpine-release ]; then
            apk update && apk add --no-cache git
          elif [ -f /etc/debian_version ]; then
            apt-get update && apt-get install -y git
          else
            echo "‚ùå Unsupported OS: Cannot install Git"
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required to detect changed files
          #cd "$GITHUB_WORKSPACE"  # ‚Üê Critical: Move into repo directory

      # - name: Find modified Markdown files
      #   id: changed-files
      #   uses: tj-actions/changed-files@v42
      #   with:
      #     files: '**.md'
      #     since_last_remote_commit: 'true'
          
      # - name: Install missing LaTeX packages (if needed)
      #   run: |
      #     tlmgr update --self
      #     tlmgr install beamer
      #     # tlmgr navigation

      # - name: Get changed files via GitHub API
      #   id: changed-files
      #   uses: jitterbit/get-changed-files@v1
      #   with:
      #     format: space-delimited  # Lista de archivos separados por espacios

      # - name: Get changed files
      #   id: changed-files
      #   uses: tj-actions/changed-files@v44  # Versi√≥n estable m√°s reciente
      #   with:
      #     separator: ' '  # Formato de salida

      # - name: Get changed Markdown files
      #   id: changed-files
      #   run: |
      #     # Obtiene archivos .md modificados en el √∫ltimo commit (push)
      #     files=$(git diff --name-only HEAD^ HEAD | grep '\.md$' || true)
          
      #     # Formato moderno para outputs (GITHUB_OUTPUT)
      #     delimiter="EOF_$(openssl rand -hex 6)"
      #     echo "changed_md_files<<${delimiter}" >> $GITHUB_OUTPUT
      #     echo "$files" >> $GITHUB_OUTPUT
      #     echo "${delimiter}" >> $GITHUB_OUTPUT
      #     echo "üìÑ Archivos modificados: $files"

      # - name: Filter Markdown files
      #   id: filter-md
      #   run: |
      #     # Filtra solo archivos .md
      #     md_files=$(echo "${{ steps.changed-files.outputs.all }}" | tr ' ' '\n' | grep '\.md$' || true)
      #     echo "changed_md_files=$md_files" >> $GITHUB_OUTPUT
      #     echo "Markdown files changed: $md_files"

      - name: Process files in container
        run: |
          PREV_SHA=$(git log --pretty=format:%H -n 2 | tail -1)
          mkdir -p pdfs
          for file in $(git diff --no-index --name-only $PREV_SHA HEAD | grep '\.md$' || true); do
          # for file in ${{ steps.changed-files.outputs.all }}; do
              
            if [[ "$file" != *.md ]]; then
              echo "‚ùå Ignorando (no es .md): $file"
              continue  # Salta a la siguiente iteraci√≥n
            fi

            echo "Processing file: ${file}"
            # Check if the markdown file indicates it's a Beamer presentation by searching for a 'Beamer' keyword in metadata
            if grep -qi 'beamer' "${file}"; then
                echo "Detected Beamer presentation in ${file}. Converting using Beamer template."
                pandoc "${file}" -t beamer -o "pdfs/${file%.*}.pdf"
            else
                echo "Converting ${file} as a standard markdown document."
                pandoc "${file}" -o "pdfs/${file%.*}.pdf"
            fi
          done

      # - name: Get list of modified markdown files
      #   id: files
      #   run: |
      #     # List markdown files changed in the commit or pull request
      #     files=$(git diff --name-only ${{ github.sha }}^ ${{ github.sha }} | grep '\.md$' || true)
      #     echo "changed_md_files=$files" >> $GITHUB_OUTPUT
      #     echo "Found the following markdown files to convert:"
      #     echo "$files"

      # - name: Convert markdown files to PDF
      #   if: steps.files.outputs.changed_md_files != ''
      #   run: |
      #     # Split the list into an array
      #     IFS=$'\n' read -r -d '' -a md_files <<< "${{ steps.files.outputs.changed_md_files }}" || true
      #     for md in "${md_files[@]}"; do
      #         echo "Processing file: ${md}"
      #         # Check if the markdown file indicates it's a Beamer presentation by searching for a 'Beamer' keyword in metadata
      #         if grep -qi 'beamer' "${md}"; then
      #             echo "Detected Beamer presentation in ${md}. Converting using Beamer template."
      #             pandoc "${md}" -t beamer -o "${md%.*}.pdf"
      #         else
      #             echo "Converting ${md} as a standard markdown document."
      #             pandoc "${md}" -o "${md%.*}.pdf"
      #         fi
      #     done
      
      # - name: Convert to PDF
      #   run: |
      #     for file in $(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '\.md$'); do
      #       if [[ -f "$file" ]]; then
      #         echo "Processing $file..."
      #         output="${file%.md}.pdf"

      #         # Check if file contains presentation markers
      #         if grep -q '^theme:' "$file" || grep -q '^class: beamer' "$file"; then
      #           pandoc "$file" -o "$output" \
      #             -t beamer \
      #             -V theme:metropolis \
      #             --pdf-engine=xelatex
              
      #         else
      #           pandoc "$file" -o "$output" \
      #             --template=eisvogel \
      #             --listings \
      #             -V geometry:margin=1.5cm \
      #             --pdf-engine=xelatex
      #         fi
      #       fi
      #     done
      # # cd "$GITHUB_WORKSPACE"  # ‚Üê Critical: Move into repo directory

      - name: Commit and push PDFs
        run: |
          
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add docs/*.pdf
          git diff --quiet && git diff --staged --quiet || git commit -m "Auto-generate PDFs [skip ci]"
          git push

      # - name: Upload PDF artifacts
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: generated-pdfs
      #     path: '**.pdf'
