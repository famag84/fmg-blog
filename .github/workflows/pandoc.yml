name: Convert Markdown to PDF
on:
  push:
    paths:
      - '**.md'  # Trigger only when .md files change
      
jobs:
  convert:
    runs-on: ubuntu-latest
    # Uses GitHub's native runner with Git preinstalled
    container:
      image: pandoc/latex:latest  # Official Pandoc+LaTeX image
      
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required to detect changed files
      
      # - name: Setup Pandoc and LaTeX
      #   run: |
      #     sudo apt-get update
      #     sudo apt-get install -y pandoc texlive-full
      #     sudo tlmgr install eisvogel beamer-metropolis
          
      # - name: Find modified Markdown files
      #   id: changed-files
      #   uses: tj-actions/changed-files@v42
      #   with:
      #     files: '**.md'
      #     since_last_remote_commit: 'true'
          
      - name: Install missing LaTeX packages (if needed)
        run: |
          tlmgr update --self
          tlmgr install beamer
          # tlmgr navigation
          
      - name: Convert to PDF
        run: |
          for file in $(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '\.md$'); do
            if [[ -f "$file" ]]; then
              echo "Processing $file..."
              output="${file%.md}.pdf"

              # Check if file contains presentation markers
              if grep -q '^theme:' "$file" || grep -q '^class: beamer' "$file"; then
                pandoc "$file" -o "$output" \
                  -t beamer \
                  -V theme:metropolis \
                  --pdf-engine=xelatex
              
              else
                pandoc "$file" -o "$output" \
                  --template=eisvogel \
                  --listings \
                  -V geometry:margin=1.5cm \
                  --pdf-engine=xelatex
              fi
            fi
          done

      - name: Upload PDF artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated-pdfs
          path: '**.pdf'
